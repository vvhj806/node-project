<div class="d-flex flex-column flex-root app-root" id="kt_app_root">
	<div class="app-page flex-column flex-column-fluid" id="kt_app_page">
		<%- include(theme.getLayoutPath("partials/sidebar-layout/_header.ejs")); %>
        <div class="app-wrapper flex-column flex-row-fluid" id="kt_app_wrapper">
            <%- include(theme.getLayoutPath("partials/sidebar-layout/_sidebar.ejs")); %>
            <div class="app-main flex-column flex-row-fluid" id="kt_app_main">
                <!--begin::Content wrapper-->
                <div class="d-flex flex-column flex-column-fluid">                    
                    <div id="kt_app_content" class="app-content flex-column-fluid">
                        <div id="kt_app_content_container" class="app-container container-fluid mg_t_30">

                            <div class="d-flex flex-column flex-column-fluid">
                                <!--begin::Header-->
                                <div id="kt_app_toolbar" class="app-toolbar  py-3 py-lg-6 ">
                                    <div id="kt_app_toolbar_container" class="app-container  container-xxl d-flex flex-stack ">
                                        <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3 ">
                                            <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">메뉴 관리</h1>
                            
                                            <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                                                <li class="breadcrumb-item text-muted">메뉴</li>
                                                <li class="breadcrumb-item"><span class="bullet bg-gray-400 w-5px h-2px"></span></li>
                                                <li class="breadcrumb-item text-muted">메뉴 관리 </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <!--end::Header-->                                        
                                                

                                <!--begin::Content-->
                                <div id="kt_app_content" class="app-content  flex-column-fluid ">
                                    <div id="kt_app_content_container" class="app-container container-xxl">
                                        <div class="card padding_20">
                                            <div class="card-body p-0 manage_menu_flex">
                                                <div style="width: 65%;">
                                                    <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column my-0">메뉴리스트</h1>

                                                    <div class="card h-xl-100">
                                                        <div class="card-header border-0 pt-5">
                                                            <h3 class="card-title align-items-start flex-column">
                                                                <!-- <span class="card-label fw-bold text-dark">메뉴 리스트</span> -->
                                                                <span class="text-muted mt-1 fw-semibold fs-7">각 메뉴를 클릭하면 우측에서 서브 메뉴를 확인 할 수 있습니다.</span>
                                                            </h3>
                                                    
                                                            <div class="card-toolbar">   
                                                                <div class="btn btn-sm btn-light" id="add_menu">+ 메뉴추가</div>             
                                                            </div>
                                                        </div>
                                                    
                                                        <!--begin::Menu list-->
                                                        <div class="card-body pt-6">

                                                            <% data.menuList.forEach((item, index) => { %>
                                                                <div class="d-flex flex-stack menu_item pd_10 pointer" data-idx="<%=item.idx%>" data-menu_nm="<%=item.menu_nm%>">  
                                                                    <div class="symbol symbol-35px me-4">
                                                                        <% if(item.use_yn == 'y') { %>
                                                                            <div class="symbol-label fw-semibold bg-success text-inverse-success">ON</div>
                                                                        <% } else { %>
                                                                            <div class="symbol-label fw-semibold bg-danger text-inverse-danger">OFF</div>
                                                                        <% } %>
                                                                    </div>
                                                        
                                                                    <div class="d-flex align-items-center flex-row-fluid flex-wrap">
                                                                        <div class="flex-grow-1 me-2">
                                                                            <div class="text-gray-800 fs-6 fw-bold"><%=item.menu_nm%></div>
                                                                            <span class="text-muted fw-semibold d-block fs-7"><%=item.menu_nm%></span>
                                                                        </div>
                                                                        
                                                                        <div class="btn btn-sm btn-icon btn-bg-light btn-active-color-primary w-30px h-30px mg_r_5 mod_menu" data-idx="<%=item.idx%>" data-name="<%=item.menu_nm%>" data-use="<%=item.use_yn%>">수정</div>
                                                                        <div class="btn btn-sm btn-icon btn-bg-light btn-active-color-primary w-30px h-30px del_menu" data-idx="<%=item.idx%>">삭제</div>
                                                                    </div>
                                                                </div>
                                                        
                                                                <div class="separator separator-dashed my-4"></div>
                                                            <% }); %>

                                                            <!--    
                                                            <div class="d-flex flex-stack">  
                                                                <div class="symbol symbol-40px me-4">
                                                                    <div class="symbol-label fs-2 fw-semibold bg-info text-inverse-info">W</div>
                                                                </div>
                                                    
                                                                <div class="d-flex align-items-center flex-row-fluid flex-wrap">
                                                                    <div class="flex-grow-1 me-2">
                                                                        <a href="/metronic8/demo1/../demo1/pages/user-profile/overview.html" class="text-gray-800 text-hover-primary fs-6 fw-bold">다이닝</a>
                                                                        
                                                                        <span class="text-muted fw-semibold d-block fs-7">다이닝</span>
                                                                    </div>
                                                                    
                                                                    <a href="#" class="btn btn-sm btn-icon btn-bg-light btn-active-color-primary w-30px h-30px">
                                                                        <i class="ki-duotone ki-arrow-right fs-2">
                                                                            <span class="path1"></span>
                                                                            <span class="path2"></span>
                                                                        </i>
                                                                    </a>
                                                                </div>
                                                            </div>
                                                    
                                                            <div class="separator separator-dashed my-4"></div>
                                                                        
                                                            <div class="d-flex flex-stack">  
                                                                <div class="symbol symbol-40px me-4">
                                                                    <div class="symbol-label fs-2 fw-semibold bg-primary text-inverse-primary">M</div>
                                                                </div>
                                                    
                                                                <div class="d-flex align-items-center flex-row-fluid flex-wrap">
                                                                    <div class="flex-grow-1 me-2">
                                                                        <a href="/metronic8/demo1/../demo1/pages/user-profile/overview.html" class="text-gray-800 text-hover-primary fs-6 fw-bold">부대시설</a>
                                                                        
                                                                        <span class="text-muted fw-semibold d-block fs-7">부대시설</span>
                                                                    </div>
                                                                    
                                                                    <a href="#" class="btn btn-sm btn-icon btn-bg-light btn-active-color-primary w-30px h-30px">
                                                                        <i class="ki-duotone ki-arrow-right fs-2">
                                                                            <span class="path1"></span>
                                                                            <span class="path2"></span>
                                                                        </i>
                                                                    </a>
                                                                </div>
                                                            </div>
                                                    
                                                            <div class="separator separator-dashed my-4"></div>
                                                                        
                                                            <div class="d-flex flex-stack">  
                                                                <div class="symbol symbol-40px me-4">
                                                                    <div class="symbol-label fs-2 fw-semibold bg-dark text-inverse-dark">M</div>
                                                                </div>
                                                    
                                                                <div class="d-flex align-items-center flex-row-fluid flex-wrap">
                                                                    <div class="flex-grow-1 me-2">
                                                                        <a href="/metronic8/demo1/../demo1/pages/user-profile/overview.html" class="text-gray-800 text-hover-primary fs-6 fw-bold">Mathematics</a>
                                                                        
                                                                        <span class="text-muted fw-semibold d-block fs-7">24+ Courses</span>
                                                                    </div>
                                                                    
                                                                    <a href="#" class="btn btn-sm btn-icon btn-bg-light btn-active-color-primary w-30px h-30px">
                                                                        <i class="ki-duotone ki-arrow-right fs-2">
                                                                            <span class="path1"></span>
                                                                            <span class="path2"></span>
                                                                        </i>
                                                                    </a>
                                                                </div>
                                                            </div>
                                                             -->

                                                        </div>
                                                        <!--end::Menu list-->
                                                    </div>
                                                </div>

                                                <div class="col-xl-4 mb-xl-10" style="width: 35%;">       
                                                    <div class="card card-flush h-xl-100" style="background-color: #F5F8FA;">   
                                                        <div class="card-header rounded bgi-no-repeat bgi-size-cover bgi-position-y-top bgi-position-x-center align-items-start" data-bs-theme="light">
                                                            <div class="card-title pt-15 flex">
                                                                <div class="fs-4">
                                                                    <h1 class="page-heading d-flex text-dark fw-bold fs-3 my-0">서브 메뉴 리스트</h1>
                                                                </div>    
                                                                <div class="card-toolbar">   
                                                                    <div class="btn btn-sm btn-light" id="add_sub_menu" style="display: none;">+ 메뉴추가</div>             
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="card-header rounded bgi-no-repeat bgi-size-cover bgi-position-y-top bgi-position-x-center align-items-start" id="menu_name" style="min-height: 0;"></div>
                                                    
                                                        <div class="card-body">
                                                            <div class="position-relative">
                                                                <div class="row g-3 g-lg-6" id="sub_menu"></div>
                                                            </div> 
                                                        </div>    
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--end::Content-->					
                            </div>
                        </div>
                    </div>

                    <%#- include(theme.getLayoutPath("partials/sidebar-layout/_content.ejs")); %>
                </div>
                <!--end::Content wrapper-->
                <%- include(theme.getLayoutPath("partials/sidebar-layout/_footer.ejs")); %>
            </div>
        </div>
	</div>
</div>

<%- include(theme.getPartialPath("partials/_drawers.ejs")); %>

<script>
    let currMenuIdx = '';

    // 메뉴 추가
    $('#add_menu').on('click', function() {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            buttonsStyling: false
        });

        swalWithBootstrapButtons.fire({
            title: '<div class="b">메뉴 추가</div>',
            html: `
                <div>추가할 메뉴명을 입력해주세요!</div>
                <input id="new_menu_name" class="swal2-input" placeholder="메뉴명을 입력해주세요.">

                <div class="mg_t_10 menu_isused_wrap">
                    <span>사용여부</span>
                    <span class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="menu_use_toggle" checked>
                        <span id="toggle_text" class="toggle_text">ON</span>
                    </span>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: '확인',
            cancelButtonText: '닫기',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                const menuName = $('#new_menu_name').val();
                let menuIsUsed = $('#menu_use_toggle').prop('checked');

                if(menuIsUsed) {
                    menuIsUsed = 'y';
                } else {
                    menuIsUsed = 'n';
                }

                if(menuName == '' || menuName == null) {
                    alert('메뉴명은 필수값입니다.');
                } else {
                    axios.post('/dashboards/add_menu', {
                        menuName: menuName, 
                        menuIsUsed: menuIsUsed
                    }).then(function (response) {
                        if (response) {
                            if(response.data.state == 200) {
                                alert('추가되었습니다.')
                                location.reload();
                            } else {
                                alert('문제가 발생했습니다. 다시 시도해주세요.');
                                location.reload();
                            }
                        } else {
                            alert('저장에 문제가 발생했습니다. 다시 시도해주세요.');
                            location.reload();
                        }
                    }).catch(function (error) {
                        alert('저장에 문제가 발생했습니다. 다시 시도해주세요.');
                        location.reload();
                    });
                }
            }
        });

        $('#menu_use_toggle').on('change', function() {
            var isChecked = $(this).prop('checked');
            var text = isChecked ? 'ON' : 'OFF';
            $('#toggle_text').text(text);
        });
    });

    // 메뉴 수정
    $('.mod_menu').on('click', function(){
        const idx = $(this).data('idx');
        let name = $(this).data('name');
        let useState = $(this).data('use');

        if(useState == 'y') {
            useState = 'checked';
        } else {
            useState = '';
        }

        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            buttonsStyling: false
        });

        swalWithBootstrapButtons.fire({
            title: '<div class="b">메뉴 수정</div>',
            html: `
                <input id="mod_menu_name" class="swal2-input" placeholder="메뉴명을 입력해주세요." value="${name}">

                <div class="mg_t_10 menu_isused_wrap">
                    <span>사용여부</span>
                    <span class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="menu_use_mod_toggle" ${useState}>
                        <span id="toggle_text" class="toggle_text">ON</span>
                    </span>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: '수정',
            cancelButtonText: '취소',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                const menuName = $('#mod_menu_name').val();
                let menuIsUsed = $('#menu_use_mod_toggle').prop('checked');

                if(menuIsUsed) {
                    menuIsUsed = 'y';
                } else {
                    menuIsUsed = 'n';
                }

                if(menuName == '' || menuName == null) {
                    alert('메뉴명은 필수값입니다.');
                } else {
                    axios.post('/dashboards/mod_menu', {
                        idx: idx,
                        menuName: menuName, 
                        menuIsUsed: menuIsUsed
                    }).then(function (response) {
                        if (response) {
                            if(response.data.state == 200) {
                                alert('수정되었습니다.')
                                location.reload();
                            } else {
                                alert('문제가 발생했습니다. 다시 시도해주세요.');
                                location.reload();
                            }
                        } else {
                            alert('저장에 문제가 발생했습니다. 다시 시도해주세요.');
                            location.reload();
                        }
                    }).catch(function (error) {
                        alert('저장에 문제가 발생했습니다. 다시 시도해주세요.');
                        location.reload();
                    });
                }
            }
        });
    });

    // 메뉴 삭제
    $('.del_menu').on('click', function(){
        const idx = $(this).data('idx');

        Swal.fire({
            title: '삭제하시겠습니까?',
            text: "삭제하시면 복구가 어렵습니다.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#50CD89',
            cancelButtonColor: '#d33',
            confirmButtonText: '삭제',
            cancelButtonText: '취소',
        }).then((result) => {
            if (result.isConfirmed) {
                axios.post('/dashboards/del_menu', {
                    idx: idx
                }).then(function (response) {
                    if (response) {
                        if(response.data.state == 200) {
                            Swal.fire('삭제 완료!','정상적으로 삭제 되었습니다.','success');
                            setTimeout(function() {
                                location.reload();
                            }, 1000);
                        } else {
                            alert('문제가 발생했습니다. 다시 시도해주세요.');
                            location.reload();
                        }
                    } else {
                        alert('삭제에 문제가 발생했습니다. 다시 시도해주세요.');
                        location.reload();
                    }
                }).catch(function (error) {
                    alert('삭제에 문제가 발생했습니다. 다시 시도해주세요.');
                    location.reload();
                });
            }
        });
    });

    // 대 메뉴 클릭시 서브 메뉴 불러오기
    $('.menu_item').on('click', function(){
        const menuIdx = $(this).data('idx');
        const menuName = $(this).data('menu_nm');
        currMenuIdx = menuIdx;

        axios.post('/dashboards/get_sub_menu', {
            menuIdx: menuIdx
        }).then(function (response) {
            if (response) {
                if(response.data.state == 200) {
                    $('.menu_item').css('background-color', '#fff');
                    $(this).css('background-color', '#F4F8FF');
                    $('#menu_name').text('(' + menuName + ')');
                    $('#add_sub_menu').show();
                    $('#sub_menu').empty();

                    response.data.data.forEach(function(item, index){
                        console.log(item);

                        $('#sub_menu').append(`
                            <div class="bg-gray-100 bg-opacity-70 rounded-2 px-6 py-5" style="border: 1px solid #aaa;">
                                <div class="m-0" style="display: flex;justify-content: space-between;">
                                    <span class="text-gray-700 fw-bolder d-block">${item.menu_nm}</span>
                                    <span>
                                        <span class="pointer mod_sub_menu" data-idx="${item.idx}" data-sub_menu_nm="${item.menu_nm}">수정</span>
                                        <span class="pointer del_sub_menu" data-idx="${item.idx}">삭제</span>
                                    </span>
                                </div>
                            </div>   
                        `);
                    });

                    $('.mod_sub_menu').on('click', function(){
                        const idx = $(this).data('idx');
                        const subMenuNm = $(this).data('sub_menu_nm');
                        modSubMenu(idx, subMenuNm)
                    });

                    $('.del_sub_menu').on('click', function(){
                        const idx = $(this).data('idx');
                        delSubMenu(idx);
                    });
                                    
                } else {
                    alert('문제가 발생했습니다. 다시 시도해주세요.');
                    location.reload();
                }
            } else {
                alert('문제가 발생했습니다. 다시 시도해주세요.');
                location.reload();
            }
        }).catch(function (error) {
            alert('문제가 발생했습니다. 다시 시도해주세요.');
            location.reload();
        });
    });

    $('#add_sub_menu').on('click', function(){
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            buttonsStyling: false
        });

        swalWithBootstrapButtons.fire({
            title: '<div class="b">서브 메뉴 추가</div>',
            html: `
                <div>추가할 메뉴명을 입력해주세요!</div>
                <input id="new_sub_menu_name" class="swal2-input" placeholder="메뉴명을 입력해주세요.">
            `,
            showCancelButton: true,
            confirmButtonText: '확인',
            cancelButtonText: '닫기',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                const subMenuName = $('#new_sub_menu_name').val();

                if(subMenuName == '' || subMenuName == null) {
                    alert('메뉴명은 필수값입니다.');
                } else if(currMenuIdx == '' || currMenuIdx == null) {
                    alert('문제가 발생했습니다. 다시 시도해주세요.');
                    location.reload();
                } else {
                    axios.post('/dashboards/add_sub_menu', {
                        currMenuIdx: currMenuIdx,
                        subMenuName: subMenuName
                    }).then(function (response) {
                        if (response) {
                            if(response.data.state == 200) {
                                alert('추가되었습니다.');
                                location.reload();
                            } else {
                                alert('문제가 발생했습니다. 다시 시도해주세요.');
                                location.reload();
                            }
                        } else {
                            alert('저장에 문제가 발생했습니다. 다시 시도해주세요.');
                            location.reload();
                        }
                    }).catch(function (error) {
                        alert('저장에 문제가 발생했습니다. 다시 시도해주세요.');
                        location.reload();
                    });
                }
            }
        });
    });

    $('.mod_sub_menu').on('click', function(){
        const idx = $(this).data('idx');
        const subMenuNm = $(this).data('sub_menu_nm');

        console.log(idx);
        console.log(subMenuNm);
    });

    function modSubMenu(idx, subMenuNm){

    }

    function delSubMenu(idx) {

    }
</script>
